var RadarAnalytics=function(g){"use strict";var E=typeof global=="object"&&global&&global.Object===Object&&global,A=typeof self=="object"&&self&&self.Object===Object&&self,H=E||A||Function("return this")(),S=H.Symbol,O=Object.prototype,N=O.hasOwnProperty,x=O.toString,p=S?S.toStringTag:void 0;function B(i){var e=N.call(i,p),t=i[p];try{i[p]=void 0;var r=!0}catch{}var s=x.call(i);return r&&(e?i[p]=t:delete i[p]),s}var F=Object.prototype,V=F.toString;function z(i){return V.call(i)}var J="[object Null]",G="[object Undefined]",D=S?S.toStringTag:void 0;function m(i){return i==null?i===void 0?G:J:D&&D in Object(i)?B(i):z(i)}function b(i){return i!=null&&typeof i=="object"}var f=Array.isArray;function a(i){var e=typeof i;return i!=null&&(e=="object"||e=="function")}var K="[object AsyncFunction]",W="[object Function]",Q="[object GeneratorFunction]",X="[object Proxy]";function c(i){if(!a(i))return!1;var e=m(i);return e==W||e==Q||e==K||e==X}function Y(i){return function(e){return i(e)}}var T=typeof g=="object"&&g&&!g.nodeType&&g,v=T&&typeof module=="object"&&module&&!module.nodeType&&module,Z=v&&v.exports===T,P=Z&&E.process,j=function(){try{var i=v&&v.require&&v.require("util").types;return i||P&&P.binding&&P.binding("util")}catch{}}();function ee(i){return""}var te="[object String]";function o(i){return typeof i=="string"||!f(i)&&b(i)&&m(i)==te}var re="[object Boolean]";function ie(i){return i===!0||i===!1||b(i)&&m(i)==re}var se="[object Date]";function ne(i){return b(i)&&m(i)==se}var k=j&&j.isDate,L=k?Y(k):ne,oe="[object Number]";function ae(i){return typeof i=="number"||b(i)&&m(i)==oe}var he=0;function ce(i){var e=++he;return ee()+e}function ue(i,e){for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a(e[t])&&a(i[t])?(Object.assign(i)[t],e[t]):i[t]=e[t]);return i}function I(i){if(!a(i)&&!f(i))return i;if(f(i))return i.map(I);const e={};for(const t in i)Object.prototype.hasOwnProperty.call(i,t)&&(L(i[t])?e[t]=i[t].toISOString():a(i[t])||f(i[t])?e[t]=I(i[t]):e[t]=i[t]);return e}function l(){return Date.now()}function _(){return Math.random()}function le(){return{screenHeight:window.screen.height,screenWidth:window.screen.width,devicePixelRatio:window.devicePixelRatio||1}}function ge(){const i=navigator.userAgent.toLowerCase(),e={};let t;return(t=i.match(/ qq\/([\d.]+)/))?e.qqBuildinBrowser=Number(t[1].split(".")[0]):(t=i.match(/mqqbrowser\/([\d.]+)/))?e.qqBrowser=Number(t[1].split(".")[0]):(t=i.match(/opera.([\d.]+)/))?e.opera=Number(t[1].split(".")[0]):(t=i.match(/msie ([\d.]+)/))?e.ie=Number(t[1].split(".")[0]):(t=i.match(/edge.([\d.]+)/))?e.edge=Number(t[1].split(".")[0]):(t=i.match(/firefox\/([\d.]+)/))?e.firefox=Number(t[1].split(".")[0]):(t=i.match(/chrome\/([\d.]+)/))?e.chrome=Number(t[1].split(".")[0]):(t=i.match(/version\/([\d.]+).*safari/))?e.safari=Number(t[1].match(/^\d*.\d*/)):(t=i.match(/trident\/([\d.]+)/))&&(e.ie=11),e}function de(){const i=location.protocol;return i==="http:"||i==="https:"?i:"http:"}function R(i,e=!1){if(o(i))return i;const t=document.referrer||"";return e?t:t.split("?")[0]}class fe{constructor(e={}){this.domain=e.domain||"",this.secure=e.secure||!1,this.crossSubdomain=e.crossSubdomain!==!1}isSupport(){return typeof document<"u"&&c(document.cookie)}get(e){if(!o(e)||!this.isSupport())return"";const t=e+"=",r=document.cookie.split(";");for(let s=0;s<r.length;s++){let n=r[s];for(;n.charAt(0)===" ";)n=n.substring(1,n.length);if(n.indexOf(t)===0)return decodeURIComponent(n.substring(t.length,n.length))}return""}set(e,t,r){if(!o(e)||!this.isSupport())return!1;const s=this.getCookieDomain(),n=r?"; expires="+new Date(new Date().getTime()+r*24*60*60*1e3).toUTCString():"",h=this.secure?"; secure":"",u=this.secure?"; SameSite=None":"";return document.cookie=e+"="+encodeURIComponent(t)+n+"; path=/"+s+h+u,!0}remove(e){return!o(e)||!this.isSupport()?!1:(this.set(e,"",-1),!0)}getCookieDomain(){if(!this.crossSubdomain)return"";const e=document.location.hostname;return this.domain?"; domain="+this.domain:e.match(/^\d+\.\d+\.\d+\.\d+$/)?"":"; domain=."+e.split(".").slice(-2).join(".")}}class pe{isSupport(){const e="__sensors_test_localStorage";try{return window.localStorage.setItem(e,"1"),window.localStorage.removeItem(e),!0}catch{return!1}}get(e){if(!o(e)||!this.isSupport())return"";try{return window.localStorage.getItem(e)||""}catch{return""}}set(e,t){if(!o(e)||!this.isSupport())return!1;try{return window.localStorage.setItem(e,t),!0}catch{return!1}}remove(e){if(!o(e)||!this.isSupport())return!1;try{return window.localStorage.removeItem(e),!0}catch{return!1}}}class me{isSupport(){const e="__sensors_test_sessionStorage";try{return window.sessionStorage.setItem(e,"1"),window.sessionStorage.removeItem(e),!0}catch{return!1}}get(e){if(!o(e)||!this.isSupport())return"";try{return window.sessionStorage.getItem(e)||""}catch{return""}}set(e,t){if(!o(e)||!this.isSupport())return!1;try{return window.sessionStorage.setItem(e,t),!0}catch{return!1}}remove(e){if(!o(e)||!this.isSupport())return!1;try{return window.sessionStorage.removeItem(e),!0}catch{return!1}}}class M{constructor(){this.storage={}}isSupport(){return!0}get(e){return o(e)&&this.storage[e]||""}set(e,t){return o(e)?(this.storage[e]=t,!0):!1}remove(e){return o(e)?(delete this.storage[e],!0):!1}}class ve{constructor(e={}){this.currentStorage=null,this.storages=[new pe,new fe(e),new me,new M],this.initStorage()}initStorage(){for(const e of this.storages)if(e.isSupport()){this.currentStorage=e;break}this.currentStorage||(this.currentStorage=new M)}get(e){if(!this.currentStorage)return"";const t=this.currentStorage.get(e);try{return JSON.parse(t)}catch{return t||""}}set(e,t,r){if(!this.currentStorage)return!1;let s=t;return a(t)&&(s=JSON.stringify(t)),this.currentStorage.set(e,String(s),r)}remove(e){return this.currentStorage?this.currentStorage.remove(e):!1}}class Se{constructor(e){this.identities={},this.firstId="",this.distinctId="",this.loginId="",this.storage=e.storage,this.cookieName=e.cookieName||"sensorsdata2015jssdkcross",this.initIdentity()}initIdentity(){const e=this.storage.get(this.cookieName);e&&typeof e=="object"&&(e.identities&&typeof e.identities=="object"&&(this.identities=e.identities),o(e.first_id)&&(this.firstId=e.first_id),o(e.distinct_id)&&(this.distinctId=e.distinct_id)),this.getAnonymousId()||this.resetAnonymousId(),this.firstId||(this.firstId=this.getAnonymousId()),this.distinctId||(this.distinctId=this.getAnonymousId()),this.saveIdentities()}getAnonymousId(){return this.identities.$identity_anonymous_id||""}resetAnonymousId(){const e=ce();return this.identities.$identity_anonymous_id=e,(this.distinctId===this.getAnonymousId()||!this.distinctId)&&(this.distinctId=e),this.saveIdentities(),e}getLoginId(){return this.identities.$identity_login_id||""}setLoginId(e,t=!0){!o(e)||!e||(this.identities.$identity_login_id=e,this.distinctId=e,this.loginId=e,t&&this.saveIdentities())}clearLoginId(){delete this.identities.$identity_login_id,this.distinctId=this.getAnonymousId(),this.loginId="",this.saveIdentities()}getDistinctId(){return this.distinctId||this.getAnonymousId()}getFirstId(){return this.firstId}setIdentity(e,t){!o(e)||!e.startsWith("$identity_")||!o(t)||!t||(this.identities[e]=t,this.saveIdentities())}getIdentities(){return{...this.identities}}saveIdentities(){const e={distinct_id:this.distinctId,first_id:this.firstId,identities:this.identities};this.storage.set(this.cookieName,e,730)}getUserIdentity(){return{anonymous_id:this.getAnonymousId(),login_id:this.getLoginId(),distinct_id:this.getDistinctId(),first_id:this.getFirstId(),identities:this.getIdentities()}}login(e){return!o(e)||!e?this.getUserIdentity():this.getLoginId()===e?this.getUserIdentity():(this.setLoginId(e),this.getUserIdentity())}logout(){return this.clearLoginId(),this.getUserIdentity()}}class be{constructor(){this.events={},this.onceEvents={}}on(e,t){c(t)&&(this.events[e]||(this.events[e]=[]),this.events[e].push(t))}once(e,t){c(t)&&(this.onceEvents[e]||(this.onceEvents[e]=[]),this.onceEvents[e].push(t))}off(e,t){if(!t){delete this.events[e],delete this.onceEvents[e];return}this.events[e]&&(this.events[e]=this.events[e].filter(r=>r!==t),this.events[e].length===0&&delete this.events[e]),this.onceEvents[e]&&(this.onceEvents[e]=this.onceEvents[e].filter(r=>r!==t),this.onceEvents[e].length===0&&delete this.onceEvents[e])}emit(e,...t){if(this.events[e]&&this.events[e].forEach(r=>{try{r(...t)}catch(s){console.error(`Error in event handler for "${e}":`,s)}}),this.onceEvents[e]){const r=this.onceEvents[e].slice();delete this.onceEvents[e],r.forEach(s=>{try{s(...t)}catch(n){console.error(`Error in once event handler for "${e}":`,n)}})}}getListeners(e){const t=this.events[e]||[],r=this.onceEvents[e]||[];return[...t,...r]}hasListeners(e){return this.events[e]&&this.events[e].length>0||this.onceEvents[e]&&this.onceEvents[e].length>0}clearAllListeners(){this.events={},this.onceEvents={}}}function _e(){return typeof navigator=="object"&&typeof navigator.sendBeacon=="function"}function ye(){return!0}class we{constructor(){this.name="image"}isSupport(){return!0}async send(e){return new Promise((t,r)=>{const s=new Image,n=setTimeout(()=>{c(e.error)&&e.error(),r(new Error("Image request timeout"))},5e3);s.onload=()=>{clearTimeout(n),c(e.success)&&e.success(),t(!0)},s.onerror=()=>{clearTimeout(n),c(e.error)&&e.error(),r(new Error("Image request failed"))},s.src=e.url})}}class Pe{constructor(){this.name="beacon"}isSupport(){return _e()}async send(e){if(!this.isSupport())throw new Error("Beacon API not supported");try{const t=navigator.sendBeacon(e.url,e.data||"");return t&&c(e.success)?e.success():!t&&c(e.error)&&e.error(),t}catch(t){throw c(e.error)&&e.error(),t}}}class Ie{constructor(){this.name="ajax"}isSupport(){return ye()}async send(e){if(!this.isSupport())throw new Error("CORS not supported");return new Promise((t,r)=>{const s=new XMLHttpRequest,n=(e.type||"GET").toUpperCase(),h=e.timeout||5e3;if(s.onreadystatechange=()=>{s.readyState===4&&(s.status>=200&&s.status<300?(c(e.success)&&e.success(s.responseText),t(s.responseText)):(c(e.error)&&e.error(s.statusText),r(new Error(`HTTP error: ${s.status} ${s.statusText}`))))},s.onabort=()=>{c(e.error)&&e.error("Request aborted"),r(new Error("Request aborted"))},s.ontimeout=()=>{c(e.error)&&e.error("Request timeout"),r(new Error("Request timeout"))},s.onerror=()=>{c(e.error)&&e.error("Request failed"),r(new Error("Request failed"))},s.open(n,e.url,!0),s.timeout=h,e.credentials!==!1&&(s.withCredentials=!0),n==="POST"&&!e.headers?.["Content-Type"]&&s.setRequestHeader("Content-Type","application/json"),e.headers)for(const u in e.headers)Object.prototype.hasOwnProperty.call(e.headers,u)&&s.setRequestHeader(u,e.headers[u]);s.send(n==="POST"?JSON.stringify(e.data):null)})}}class $e{constructor(){this.name="jsonp",this.callbackPrefix="_sensorsdatajsonp_",this.callbackCounter=0}isSupport(){return!0}async send(e){return new Promise((t,r)=>{const s=e.callbackName||this.getCallbackName(),n=this.addCallbackToUrl(e.url,e.callbackFunc||"callback",s),h=document.createElement("script"),u=document.getElementsByTagName("head")[0],d=e.timeout||5e3;let $=null;window[s]=q=>{this.cleanup(s,h,$),c(e.success)&&e.success(q),t(q)},$=window.setTimeout(()=>{this.cleanup(s,h,null),c(e.error)&&e.error("Timeout"),r(new Error("JSONP request timeout"))},d),h.onerror=()=>{this.cleanup(s,h,$),c(e.error)&&e.error("Script error"),r(new Error("JSONP request failed"))},h.src=n,u.appendChild(h)})}getCallbackName(){return this.callbackCounter+=1,this.callbackPrefix+this.callbackCounter}addCallbackToUrl(e,t,r){const s=e.indexOf("?")===-1?"?":"&";return e+s+t+"="+r}cleanup(e,t,r){r&&clearTimeout(r);try{t.parentNode&&t.parentNode.removeChild(t),o(e)&&delete window[e]}catch(s){console.error("JSONP cleanup error",s)}}}class Ee{constructor(e,t={}){this.name="batch",this.queue=[],this.timer=null,this.sender=e,this.options={maxSize:t.maxSize||10,interval:t.interval||5e3}}isSupport(){return this.sender.isSupport()}async send(e){return new Promise((t,r)=>{this.queue.push({data:e,resolve:t,reject:r}),this.queue.length>=this.options.maxSize?this.flush():this.timer||(this.timer=window.setTimeout(()=>this.flush(),this.options.interval))})}flush(){if(this.timer&&(clearTimeout(this.timer),this.timer=null),this.queue.length===0)return;const e=this.queue.slice();this.queue=[];const t=this.mergeData(e.map(r=>r.data));this.sender.send(t).then(r=>{e.forEach(s=>s.resolve(r))}).catch(r=>{e.forEach(s=>s.reject(r))})}mergeData(e){return{...e[0],data:e.map(t=>t.data||t)}}}class Oe{constructor(){this.senders={},this.registerDefaultSenders()}registerDefaultSenders(){this.register(new we),this.register(new Pe),this.register(new Ie),this.register(new $e)}register(e){e&&e.name&&(this.senders[e.name]=e)}getSender(e){const t=this.senders[e];return t&&t.isSupport()?t:null}getAvailableSender(){const e=["beacon","ajax","image"];for(const t of e){const r=this.getSender(t);if(r)return r}return this.senders.image}createBatchSender(e,t){const r=this.getSender(e);return r?new Ee(r,t):null}}class y{constructor(e){this.interceptors=[],this.name=e}registerInterceptor(e){!e||!c(e.process)||(this.interceptors.push(e),this.sortInterceptors())}sortInterceptors(){this.interceptors.sort((e,t)=>{const r=e.priority||0;return(t.priority||0)-r})}process(e,t){if(!t||e!==this.name)return t;let r=t;for(const s of this.interceptors)try{const n=s.process(r);if(n===!1||n===null)return!1;n!==void 0&&(r=n)}catch(n){console.error(`Error in interceptor ${s.name||"unknown"} at stage ${this.name}:`,n)}return r}getInterceptors(){return[...this.interceptors]}}class De{constructor(e,t){this.plugins={},this.stageProcessors={},this.sdk=e,this.eventEmitter=t,this.initStageProcessors()}initStageProcessors(){this.stageProcessors={dataStage:new y("dataStage"),businessStage:new y("businessStage"),sendStage:new y("sendStage"),viewStage:new y("viewStage")}}registerPlugin(e,t){if(!e||!o(e.plugin_name))return console.error("Invalid plugin format"),!1;const r=e.plugin_name;return this.plugins[r]?(console.warn(`Plugin ${r} is already registered`),!1):(this.plugins[r]=e,this.sdk.readyState&&this.sdk.readyState.state>0&&this.initPlugin(r,t),!0)}initPlugin(e,t){const r=this.plugins[e];if(!r||r.plugin_is_init)return!1;try{return r.init(this.sdk,t),r.plugin_is_init=!0,this.eventEmitter.emit("plugin_initialized",e,r),!0}catch(s){return console.error(`Failed to initialize plugin ${e}:`,s),!1}}initPlugins(e){for(const t in this.plugins)if(Object.prototype.hasOwnProperty.call(this.plugins,t)){const r=e?e[t]:void 0;this.initPlugin(t,r)}}getPlugin(e){return this.plugins[e]||null}getAllPlugins(){return{...this.plugins}}getStageProcessor(e){return this.stageProcessors[e]||null}processStage(e,t){const r=this.getStageProcessor(e);return r?r.process(e,t):t}registerInterceptor(e,t){const r=this.getStageProcessor(e);return r?(r.registerInterceptor(t),!0):(console.error(`Stage ${e} does not exist`),!1)}}class Te{constructor(e,t,r={}){this.heartbeatInterval=null,this.heartbeatTime=5e3,this.pageShowStatus=!0,this.unloadStatus=!1,this.heartbeatData={},this.debug=!1,this.routerMode="history",this.sdk=e,this.eventEmitter=t,this.debug=r.debug||!1,this.routerMode=r.routerMode||"history",this.pageId=String(_()).slice(2,5)+String(_()).slice(2,4)+String(l()).slice(-4),this.startTime=l(),this.currentTime=this.startTime,this.init()}init(){this.addEventListener(),document.hidden===!0?this.pageShowStatus=!1:this.addHeartBeatInterval(),this.log("PageLeave initialized")}addEventListener(){document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this)),window.addEventListener("unload",this.handleUnload.bind(this)),window.addEventListener("pagehide",this.handlePageHide.bind(this)),this.eventEmitter.on("spa:change",this.handleSpaChange.bind(this)),this.routerMode==="hash"?(window.addEventListener("hashchange",this.handleHashChange.bind(this)),this.log("hash mode")):this.log("history mode")}removeEventListener(){document.removeEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.removeEventListener("beforeunload",this.handleBeforeUnload.bind(this)),window.removeEventListener("unload",this.handleUnload.bind(this)),window.removeEventListener("pagehide",this.handlePageHide.bind(this)),this.eventEmitter.off("spa:change",this.handleSpaChange.bind(this)),this.routerMode==="hash"&&window.removeEventListener("hashchange",this.handleHashChange.bind(this))}handleVisibilityChange(){document.hidden===!0?(this.pageShowStatus=!1,this.saveHeartbeat(),this.clearHeartbeatInterval()):(this.pageShowStatus=!0,this.reissueHeartbeat(),this.addHeartBeatInterval())}handleBeforeUnload(){this.unloadStatus=!0,this.saveHeartbeat(),this.trackPageLeave()}handleUnload(){this.unloadStatus||this.trackPageLeave()}handlePageHide(){this.saveHeartbeat(),this.unloadStatus||this.trackPageLeave()}handleSpaChange(e,t){this.saveHeartbeat(),this.trackPageLeave(),this.resetState()}handleHashChange(e){this.log("Hash route changed",{oldURL:e.oldURL,newURL:e.newURL}),this.saveHeartbeat(),this.trackPageLeave(),this.resetState()}resetState(){this.pageId=String(_()).slice(2,5)+String(_()).slice(2,4)+String(l()).slice(-4),this.startTime=l(),this.currentTime=this.startTime,this.unloadStatus=!1,this.heartbeatData={},this.pageShowStatus&&this.addHeartBeatInterval()}addHeartBeatInterval(){this.clearHeartbeatInterval(),this.heartbeatInterval=window.setInterval(()=>{this.saveHeartbeat()},this.heartbeatTime)}clearHeartbeatInterval(){this.heartbeatInterval!==null&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}saveHeartbeat(){const e=l(),t=e-this.currentTime;this.currentTime=e,t>0&&(this.heartbeatData[this.currentTime]=t),this.log("save heartbeat",{duration:t,currentTime:this.currentTime})}reissueHeartbeat(){const e=l(),t=e-this.currentTime;this.currentTime=e,this.log("reissue heartbeat",{duration:t,currentTime:e})}trackPageLeave(){const e=this.getPageLeaveProperties();this.eventEmitter.emit("track","$pageLeave",e),this.log("track page leave",e)}getPageLeaveProperties(){const t=l()-this.startTime;let r=0;for(const s in this.heartbeatData)Object.prototype.hasOwnProperty.call(this.heartbeatData,s)&&(r+=this.heartbeatData[s]);return r===0&&(r=t),{$page_id:this.pageId,$duration:Math.round(r/1e3),$url:window.location.href,$url_path:window.location.pathname,$title:document.title}}log(e,t){this.debug&&console.log(`[PageLeave] ${e}`,t||"")}destroy(){this.clearHeartbeatInterval(),this.removeEventListener(),this.log("PageLeave destroyed")}}class je{constructor(e){this.VERSION="1.0.0",this.config=null,this.pageLeave=null,this._readyState={state:0,stateInfo:{}},this.presetProperties={},this.registerProperties={},this.pageRegisterProperties={},this.sessionRegisterProperties={},this.isDebug=!1,this.initConfig(e),this.eventEmitter=new be,this.storageManager=new ve({domain:this.config?.cross_subdomain_domain,secure:this.config?.secure_cookie,crossSubdomain:this.config?.cross_subdomain}),this.identityManager=new Se({storage:this.storageManager,cookieName:this.config?.cookie_name,cookieDomain:this.config?.cross_subdomain_domain,crossSubdomain:this.config?.cross_subdomain}),this.dataSenderFactory=new Oe,this.pluginManager=new De(this,this.eventEmitter),this._readyState.state=1,this.initPresetProperties(),this.config?.track_page_leave&&(this.pageLeave=new Te(this,this.eventEmitter,{debug:this.isDebug})),this._readyState.state=2,this.eventEmitter.emit("ready"),this.pluginManager.initPlugins(this.config?.plugins),this.config?.is_track_page_view&&this.trackPageView(),this.log("SDK initialized",this.config)}initConfig(e){const t={server_url:"",is_debug:!1,cross_subdomain:!0,send_type:"image",heatmap:!1,max_string_length:500,preset_properties:{latest_referrer:!0,latest_referrer_host:!0,latest_search_keyword:!0,latest_traffic_source_type:!0,latest_landing_page:!0,url:!0,title:!0},is_track_single_page:!1,is_track_page_view:!0,is_track_link_click:!1,is_compliance_enabled:!1,app_js_bridge:!1,track_page_leave:!0,cookie_name:"sensorsdata2015jssdkcross",plugins:{}};this.config=ue(t,e),this.isDebug=!!this.config.is_debug}initPresetProperties(){const e=this.config?.preset_properties;if(a(e)){if(e.$device_info!==!1&&(this.presetProperties.$device_info=le()),e.$browser_info!==!1&&(this.presetProperties.$browser_info=ge()),e.$protocol!==!1&&(this.presetProperties.$protocol=de()),e.latest_referrer!==!1&&(this.presetProperties.$latest_referrer=R()),e.latest_referrer_host!==!1&&this.presetProperties.$latest_referrer)try{this.presetProperties.$latest_referrer_host=new URL(this.presetProperties.$latest_referrer).hostname}catch{this.presetProperties.$latest_referrer_host=""}if(e.$first_visit_time!==!1){const t=this.storageManager.get("$first_visit_time");if(t)this.presetProperties.$first_visit_time=t;else{const r=l();this.storageManager.set("$first_visit_time",r),this.presetProperties.$first_visit_time=r}}if(e.$first_referrer!==!1){const t=this.storageManager.get("$first_referrer");if(t)this.presetProperties.$first_referrer=t;else{const r=R();this.storageManager.set("$first_referrer",r),this.presetProperties.$first_referrer=r}}if(e.$first_referrer_host!==!1){const t=this.storageManager.get("$first_referrer_host");if(!t&&this.presetProperties.$first_referrer)try{const r=new URL(this.presetProperties.$first_referrer).hostname;this.storageManager.set("$first_referrer_host",r),this.presetProperties.$first_referrer_host=r}catch{this.presetProperties.$first_referrer_host=""}else this.presetProperties.$first_referrer_host=t}}}getPresetProperties(){const e={...this.presetProperties};return this.config?.preset_properties?.url!==!1&&(e.$url=window.location.href),this.config?.preset_properties?.title!==!1&&(e.$title=document.title),e}getCommonProperties(){const e={};return Object.assign(e,this.getPresetProperties()),Object.assign(e,this.registerProperties),Object.assign(e,this.sessionRegisterProperties),Object.assign(e,this.pageRegisterProperties),e.$lib="js",e.$lib_version=this.VERSION,e.$lib_method="code",e.$time=l(),e}processProperties(e){if(!a(e))return{};const t={},r=this.config?.max_string_length||500;for(const s in e){if(!Object.prototype.hasOwnProperty.call(e,s)||s.charAt(0)==="$"&&!this.isValidPresetProperty(s))continue;let n=e[s];if(o(n))n.length>r&&(n=n.slice(0,r)),t[s]=n;else if(ae(n)||ie(n))t[s]=n;else if(L(n))t[s]=n.toISOString();else if(f(n))t[s]=n;else if(a(n))try{JSON.stringify(n).length>r?t[s]=JSON.stringify(n,null,0).slice(0,r):t[s]=n}catch{t[s]=String(n).slice(0,r)}else t[s]=String(n).slice(0,r)}return t}isValidPresetProperty(e){return["$url","$title","$referrer","$referrer_host","$url_path","$device_info","$browser_info","$protocol","$latest_referrer","$latest_referrer_host","$first_visit_time","$first_referrer","$first_referrer_host","$lib","$lib_version","$lib_method","$time","$screen_height","$screen_width","$viewport_width","$viewport_height","$device_id","$user_agent"].indexOf(e)!==-1}prepareEventData(e,t,r={}){const s=this.getCommonProperties(),n=this.processProperties(r),h=Object.assign({},s,n),u={type:e,event:t,properties:h,distinct_id:this.identityManager.getDistinctId(),time:l()},d=this.identityManager.getFirstId();return d&&d!==u.distinct_id&&(u.first_id=d),u.identities=this.identityManager.getIdentities(),u}sendEventData(e){const t=this.pluginManager.processStage("dataStage",e);if(t===!1){this.log("Event intercepted at dataStage",e);return}const r=this.pluginManager.processStage("businessStage",t);if(r===!1){this.log("Event intercepted at businessStage",t);return}const s=this.pluginManager.processStage("sendStage",r);if(s===!1){this.log("Event intercepted at sendStage",r);return}const n=this.formatData(s),h=this.dataSenderFactory.getSender(this.config?.send_type||"image");if(!h){this.log("No available sender",{sendType:this.config?.send_type});return}const u=this.buildRequestUrl(n);h.send({url:u}).then(()=>{this.log("Event sent successfully",{event:e.event,url:u})}).catch(d=>{this.log("Event sending failed",{event:e.event,error:d})})}formatData(e){const t=I(e),r=JSON.stringify(t);return{data:btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(n,h)=>String.fromCharCode(parseInt(h,16)))),gzip:0}}buildRequestUrl(e){const t=this.config?.server_url,r=t?.indexOf("?")!==-1?"&":"?";return`${t}${r}data=${e.data}&gzip=${e.gzip}`}log(e,t){this.isDebug&&console.log(`[SensorsData] ${e}`,t||"")}get readyState(){return{...this._readyState}}debug(e){this.isDebug=e,this.config&&(this.config.is_debug=e)}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}once(e,t){this.eventEmitter.once(e,t)}emit(e,...t){this.eventEmitter.emit(e,...t)}track(e,t){if(!o(e)||!e){this.log("Invalid event name",{event:e});return}const r=this.prepareEventData("track",e,t);this.sendEventData(r)}trackPageView(e){this.track("$pageview",e)}trackSignup(e,t){if(!o(e)||!e){this.log("Invalid user ID",{distinctId:e});return}const r=this.prepareEventData("track_signup","$SignUp",t);r.distinct_id=e,this.sendEventData(r),this.identityManager.login(e)}setProfile(e){if(!a(e)||Object.keys(e).length===0){this.log("Invalid user properties",{properties:e});return}const t=this.prepareEventData("profile_set","$profile_set",e);this.sendEventData(t)}setOnceProfile(e){if(!a(e)||Object.keys(e).length===0){this.log("Invalid user properties",{properties:e});return}const t=this.prepareEventData("profile_set_once","$profile_set_once",e);this.sendEventData(t)}appendProfile(e){if(!a(e)||Object.keys(e).length===0){this.log("Invalid user properties",{properties:e});return}const t=this.prepareEventData("profile_append","$profile_append",e);this.sendEventData(t)}incrementProfile(e){if(!a(e)||Object.keys(e).length===0){this.log("Invalid user properties",{properties:e});return}const t=this.prepareEventData("profile_increment","$profile_increment",e);this.sendEventData(t)}deleteProfile(){const e=this.prepareEventData("profile_delete","$profile_delete");this.sendEventData(e)}unsetProfile(e){let t={};if(f(e)?e.forEach(s=>{o(s)&&(t[s]=!0)}):a(e)&&(t=e),Object.keys(t).length===0){this.log("Invalid user properties",{properties:e});return}const r=this.prepareEventData("profile_unset","$profile_unset",t);this.sendEventData(r)}identify(e){if(!o(e)||!e){this.log("Invalid user ID",{distinctId:e});return}this.identityManager.setIdentity("$identity_anonymous_id",e)}resetAnonymousIdentity(){return this.identityManager.resetAnonymousId()}login(e){if(!o(e)||!e){this.log("Invalid login ID",{loginId:e});return}this.identityManager.login(e)}loginWithKey(e,t){if(!o(e)||!e.startsWith("$identity_")||!o(t)||!t){this.log("Invalid key name or login ID",{keyName:e,loginId:t});return}this.identityManager.setIdentity(e,t)}logout(){this.identityManager.logout()}register(e){if(!a(e)){this.log("Invalid public properties",{properties:e});return}Object.assign(this.registerProperties,e)}registerOnce(e){if(!a(e)){this.log("Invalid public properties",{properties:e});return}for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&!Object.prototype.hasOwnProperty.call(this.registerProperties,t)&&(this.registerProperties[t]=e[t])}registerPage(e){if(!a(e)){this.log("Invalid page public properties",{properties:e});return}Object.assign(this.pageRegisterProperties,e)}registerPageOnce(e){if(!a(e)){this.log("Invalid page public properties",{properties:e});return}for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&!Object.prototype.hasOwnProperty.call(this.pageRegisterProperties,t)&&(this.pageRegisterProperties[t]=e[t])}registerSession(e){if(!a(e)){this.log("Invalid session public properties",{properties:e});return}Object.assign(this.sessionRegisterProperties,e)}registerSessionOnce(e){if(!a(e)){this.log("Invalid session public properties",{properties:e});return}for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&!Object.prototype.hasOwnProperty.call(this.sessionRegisterProperties,t)&&(this.sessionRegisterProperties[t]=e[t])}clearAllRegister(){this.registerProperties={},this.pageRegisterProperties={},this.sessionRegisterProperties={}}clearPageRegister(){this.pageRegisterProperties={}}getDistinctId(){return this.identityManager.getDistinctId()}getFirstId(){return this.identityManager.getFirstId()}registerPlugin(e,t){return this.pluginManager.registerPlugin(e,t)}getPlugin(e){return this.pluginManager.getPlugin(e)}}let w=null;async function C(i){return typeof window<"u"?(w=new je(i),window&&(window.radarAnalytic=w),w):null}function U(){return w}const ke={init:C,getInstance:U};return g.default=ke,g.getInstance=U,g.init=C,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),g}({});
